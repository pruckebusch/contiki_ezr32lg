#include <stdio.h> /* For printf() */
#include "contiki.h"
#include "dev/leds.h"
#include "em_gpio.h"
#include "em_cmu.h"
#include "platform-conf.h"
#include "lib/sensors.h"
#include "battery-sensor.h"
#include "dev/button-sensor.h"
#include "gpio.h"
#include "cfs/cfs.h"
#include "cfs/cfs-coffee.h"
#include "elfloader.h"
#include "slwstk6201a-contiki-interface.h"

#define FILENAME		"system_update"
#define UPDATE_SIZE		1436

const uint8_t system_update[UPDATE_SIZE] = {
	0x7F,0x45,0x4C,0x46,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x28,0x00,
0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEC,0x01,0x00,0x00,0x00,0x00,0x00,0x05,
0x34,0x00,0x00,0x00,0x00,0x00,0x28,0x00,0x0D,0x00,0x0A,0x00,0x00,0xB5,0x87,0xB0,0x03,0x90,0x0B,0x46,
0x01,0x92,0x8D,0xF8,0x0B,0x30,0x01,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x1B,0x88,0x00,0x2B,0x02,0xD0,
0x14,0x2B,0x0D,0xD0,0x1F,0xE0,0x03,0x20,0xFF,0xF7,0xFE,0xFF,0x13,0x48,0xC8,0x21,0xFF,0xF7,0xFE,0xFF,
0x00,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x14,0x22,0x1A,0x80,0x9D,0xF8,0x17,0x30,0x00,0x2B,0x05,0xD0,
0x0C,0x48,0xFF,0xF7,0xFE,0xFF,0x03,0x46,0x00,0x2B,0x01,0xD1,0x01,0x23,0x0D,0xE0,0x03,0x20,0xFF,0xF7,
0xFE,0xFF,0x08,0x48,0xFF,0xF7,0xFE,0xFF,0xE2,0xE7,0x00,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x00,0x22,
0x1A,0x80,0x03,0x23,0x18,0x46,0x07,0xB0,0x5D,0xF8,0x04,0xFB,0x04,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x48,0x65,0x6C,0x6C,
0x6F,0x20,0x77,0x6F,0x72,0x6C,0x64,0x20,0x70,0x72,0x6F,0x63,0x65,0x73,0x73,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x48,0x65,0x6C,0x6C,0x6F,0x20,0x77,0x6F,0x72,0x6C,0x64,0x21,0x20,0x00,0x00,0x47,
0x43,0x43,0x3A,0x20,0x28,0x47,0x4E,0x55,0x20,0x54,0x6F,0x6F,0x6C,0x73,0x20,0x66,0x6F,0x72,0x20,0x41,
0x52,0x4D,0x20,0x45,0x6D,0x62,0x65,0x64,0x64,0x65,0x64,0x20,0x50,0x72,0x6F,0x63,0x65,0x73,0x73,0x6F,
0x72,0x73,0x29,0x20,0x34,0x2E,0x39,0x2E,0x33,0x20,0x32,0x30,0x31,0x35,0x30,0x35,0x32,0x39,0x20,0x28,
0x72,0x65,0x6C,0x65,0x61,0x73,0x65,0x29,0x20,0x5B,0x41,0x52,0x4D,0x2F,0x65,0x6D,0x62,0x65,0x64,0x64,
0x65,0x64,0x2D,0x34,0x5F,0x39,0x2D,0x62,0x72,0x61,0x6E,0x63,0x68,0x20,0x72,0x65,0x76,0x69,0x73,0x69,
0x6F,0x6E,0x20,0x32,0x32,0x34,0x32,0x38,0x38,0x5D,0x00,0x41,0x32,0x00,0x00,0x00,0x61,0x65,0x61,0x62,
0x69,0x00,0x01,0x28,0x00,0x00,0x00,0x05,0x43,0x6F,0x72,0x74,0x65,0x78,0x2D,0x4D,0x33,0x00,0x06,0x0A,
0x07,0x4D,0x09,0x02,0x12,0x04,0x14,0x01,0x15,0x01,0x17,0x03,0x18,0x01,0x19,0x01,0x1A,0x01,0x1E,0x06,
0x22,0x01,0x00,0x2E,0x73,0x79,0x6D,0x74,0x61,0x62,0x00,0x2E,0x73,0x74,0x72,0x74,0x61,0x62,0x00,0x2E,
0x73,0x68,0x73,0x74,0x72,0x74,0x61,0x62,0x00,0x2E,0x72,0x65,0x6C,0x2E,0x74,0x65,0x78,0x74,0x00,0x2E,
0x72,0x65,0x6C,0x2E,0x64,0x61,0x74,0x61,0x00,0x2E,0x62,0x73,0x73,0x00,0x2E,0x72,0x65,0x6C,0x2E,0x72,
0x6F,0x64,0x61,0x74,0x61,0x00,0x2E,0x63,0x6F,0x6D,0x6D,0x65,0x6E,0x74,0x00,0x2E,0x41,0x52,0x4D,0x2E,
0x61,0x74,0x74,0x72,0x69,0x62,0x75,0x74,0x65,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1B,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x4C,0x05,0x00,0x00,0x38,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x01,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x29,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB4,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0x05,0x00,0x00,0x10,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x2F,0x00,0x00,0x00,0x08,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC4,0x00,0x00,0x00,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC4,0x00,0x00,0x00,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x94,0x05,0x00,0x00,0x08,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEE,0x00,0x00,0x00,0x71,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x49,0x00,0x00,0x00,0x03,0x00,0x00,0x70,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5F,0x01,0x00,0x00,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0x01,0x00,0x00,0x59,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF4,0x03,0x00,0x00,0xF0,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,
0x08,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE4,0x04,0x00,0x00,0x68,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x06,0x00,
0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x09,0x00,
0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x11,0x00,0x03,0x00,0x20,0x00,0x00,0x00,
0x14,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x11,0x00,0x06,0x00,0x34,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x10,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,
0x57,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x63,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x70,0x72,0x6F,0x63,0x65,0x73,0x73,
0x5F,0x74,0x68,0x72,0x65,0x61,0x64,0x5F,0x68,0x77,0x5F,0x70,0x72,0x63,0x73,0x00,0x68,0x77,0x5F,0x70,
0x72,0x63,0x73,0x00,0x61,0x75,0x74,0x6F,0x73,0x74,0x61,0x72,0x74,0x5F,0x70,0x72,0x6F,0x63,0x65,0x73,
0x73,0x65,0x73,0x00,0x6C,0x65,0x64,0x73,0x5F,0x6F,0x66,0x66,0x00,0x65,0x74,0x69,0x6D,0x65,0x72,0x5F,
0x73,0x65,0x74,0x00,0x65,0x74,0x69,0x6D,0x65,0x72,0x5F,0x65,0x78,0x70,0x69,0x72,0x65,0x64,0x00,0x6C,
0x65,0x64,0x73,0x5F,0x74,0x6F,0x67,0x67,0x6C,0x65,0x00,0x70,0x75,0x74,0x73,0x00,0x24,0x00,0x00,0x00,
0x0A,0x0A,0x00,0x00,0x2C,0x00,0x00,0x00,0x0A,0x0B,0x00,0x00,0x46,0x00,0x00,0x00,0x0A,0x0C,0x00,0x00,
0x56,0x00,0x00,0x00,0x0A,0x0D,0x00,0x00,0x5C,0x00,0x00,0x00,0x0A,0x0E,0x00,0x00,0x78,0x00,0x00,0x00,
0x02,0x01,0x00,0x00,0x7C,0x00,0x00,0x00,0x02,0x02,0x00,0x00,0x04,0x00,0x00,0x00,0x02,0x02,0x00,0x00,
0x08,0x00,0x00,0x00,0x02,0x03,0x00,0x00,0x14,0x00,0x00,0x00,0x02,0x08,0x00,0x00
	/*
0x7F,0x45,0x4C,0x46,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x28,0x00,
0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA4,0x03,0x00,0x00,0x00,0x00,0x00,0x05,
0x34,0x00,0x00,0x00,0x00,0x00,0x28,0x00,0x0D,0x00,0x0A,0x00,0x00,0xB5,0x87,0xB0,0x03,0x90,0x0B,0x46,
0x01,0x92,0x8D,0xF8,0x0B,0x30,0x01,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x1B,0x88,0x00,0x2B,0x02,0xD0,
0x14,0x2B,0x0D,0xD0,0x1F,0xE0,0x03,0x20,0xFF,0xF7,0xFE,0xFF,0xC8,0x21,0x13,0x48,0xFF,0xF7,0xFE,0xFF,
0x00,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x14,0x22,0x1A,0x80,0x9D,0xF8,0x17,0x30,0x00,0x2B,0x05,0xD0,
0x0C,0x48,0xFF,0xF7,0xFE,0xFF,0x03,0x46,0x00,0x2B,0x01,0xD1,0x01,0x23,0x0D,0xE0,0x03,0x20,0xFF,0xF7,
0xFE,0xFF,0x08,0x48,0xFF,0xF7,0xFE,0xFF,0xE2,0xE7,0x00,0x23,0x8D,0xF8,0x17,0x30,0x03,0x9B,0x00,0x22,
0x1A,0x80,0x03,0x23,0x18,0x46,0x07,0xB0,0x5D,0xF8,0x04,0xFB,0x04,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x48,0x65,0x6C,0x6C,
0x6F,0x20,0x77,0x6F,0x72,0x6C,0x64,0x20,0x70,0x72,0x6F,0x63,0x65,0x73,0x73,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x48,0x65,0x6C,0x6C,0x6F,0x20,0x77,0x6F,0x72,0x6C,0x64,0x21,0x20,0x00,0x00,0x47,
0x43,0x43,0x3A,0x20,0x28,0x31,0x35,0x3A,0x35,0x2E,0x34,0x2E,0x31,0x2B,0x73,0x76,0x6E,0x32,0x34,0x31,
0x31,0x35,0x35,0x2D,0x31,0x29,0x20,0x35,0x2E,0x34,0x2E,0x31,0x20,0x32,0x30,0x31,0x36,0x30,0x39,0x31,
0x39,0x00,0x41,0x32,0x00,0x00,0x00,0x61,0x65,0x61,0x62,0x69,0x00,0x01,0x28,0x00,0x00,0x00,0x05,0x43,
0x6F,0x72,0x74,0x65,0x78,0x2D,0x4D,0x33,0x00,0x06,0x0A,0x07,0x4D,0x09,0x02,0x12,0x04,0x14,0x01,0x15,
0x01,0x17,0x03,0x18,0x01,0x19,0x01,0x1A,0x01,0x1E,0x06,0x22,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x00,0x05,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x06,0x00,
0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x04,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x80,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x1B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x00,0x09,0x00,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x11,0x00,0x03,0x00,
0x1E,0x00,0x00,0x00,0x14,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x11,0x00,0x06,0x00,0x32,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x3B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x10,0x00,0x00,0x00,0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,
0x61,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x24,0x64,0x00,
0x70,0x72,0x6F,0x63,0x65,0x73,0x73,0x5F,0x74,0x68,0x72,0x65,0x61,0x64,0x5F,0x68,0x77,0x5F,0x70,0x72,
0x63,0x73,0x00,0x24,0x74,0x00,0x61,0x75,0x74,0x6F,0x73,0x74,0x61,0x72,0x74,0x5F,0x70,0x72,0x6F,0x63,
0x65,0x73,0x73,0x65,0x73,0x00,0x6C,0x65,0x64,0x73,0x5F,0x6F,0x66,0x66,0x00,0x65,0x74,0x69,0x6D,0x65,
0x72,0x5F,0x73,0x65,0x74,0x00,0x65,0x74,0x69,0x6D,0x65,0x72,0x5F,0x65,0x78,0x70,0x69,0x72,0x65,0x64,
0x00,0x6C,0x65,0x64,0x73,0x5F,0x74,0x6F,0x67,0x67,0x6C,0x65,0x00,0x70,0x75,0x74,0x73,0x00,0x00,0x00,
0x24,0x00,0x00,0x00,0x0A,0x0F,0x00,0x00,0x2C,0x00,0x00,0x00,0x0A,0x10,0x00,0x00,0x46,0x00,0x00,0x00,
0x0A,0x11,0x00,0x00,0x56,0x00,0x00,0x00,0x0A,0x12,0x00,0x00,0x5C,0x00,0x00,0x00,0x0A,0x13,0x00,0x00,
0x78,0x00,0x00,0x00,0x02,0x01,0x00,0x00,0x7C,0x00,0x00,0x00,0x02,0x03,0x00,0x00,0x04,0x00,0x00,0x00,
0x02,0x03,0x00,0x00,0x08,0x00,0x00,0x00,0x02,0x06,0x00,0x00,0x14,0x00,0x00,0x00,0x02,0x0D,0x00,0x00,
0x00,0x2E,0x73,0x79,0x6D,0x74,0x61,0x62,0x00,0x2E,0x73,0x74,0x72,0x74,0x61,0x62,0x00,0x2E,0x73,0x68,
0x73,0x74,0x72,0x74,0x61,0x62,0x00,0x2E,0x72,0x65,0x6C,0x2E,0x74,0x65,0x78,0x74,0x00,0x2E,0x72,0x65,
0x6C,0x2E,0x64,0x61,0x74,0x61,0x00,0x2E,0x62,0x73,0x73,0x00,0x2E,0x72,0x65,0x6C,0x2E,0x72,0x6F,0x64,
0x61,0x74,0x61,0x00,0x2E,0x63,0x6F,0x6D,0x6D,0x65,0x6E,0x74,0x00,0x2E,0x41,0x52,0x4D,0x2E,0x61,0x74,
0x74,0x72,0x69,0x62,0x75,0x74,0x65,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1B,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x02,0x00,0x00,0x38,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x01,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x29,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB4,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x03,0x00,0x00,0x10,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x2F,0x00,0x00,0x00,0x08,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC4,0x00,0x00,0x00,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC4,0x00,0x00,0x00,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x03,0x00,0x00,0x08,0x00,0x00,0x00,0x0B,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEE,0x00,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x49,0x00,0x00,0x00,0x03,0x00,0x00,0x70,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1A,0x01,0x00,0x00,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x48,0x03,0x00,0x00,0x59,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x01,0x00,0x00,0x40,0x01,0x00,0x00,0x0C,0x00,0x00,0x00,
0x0D,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x02,0x00,0x00,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00 */
};

static struct etimer et_led;

PROCESS(led_test_process, "LED test process");
PROCESS(actionsensors_process, "Action Sensors");

AUTOSTART_PROCESSES(&actionsensors_process, &led_test_process);

static uint8_t active;

static void print_processes(struct process * const processes[]) {
	/* const struct process * const * p = processes; */
	printf("Starting");
	while (*processes != NULL) {
		printf(" '%s'", (*processes)->name);
		processes++;
	}
	printf("\n");
}

PROCESS_THREAD(actionsensors_process, ev, data) {

	PROCESS_BEGIN();

	clock_delay_msec(100);

	leds_off(LEDS_ALL);

	elfloader_init();

    SENSORS_ACTIVATE(button1_sensor);
    SENSORS_ACTIVATE(button0_sensor);
    SENSORS_ACTIVATE(battery_sensor);

    while (1) {
        PROCESS_WAIT_EVENT_UNTIL(ev == sensors_event);
        if(data == &button1_sensor) {
        	int fd_w = 0;
        	int r_w = 0;
        	
        	cfs_coffee_format();

			fd_w = cfs_open(FILENAME, CFS_WRITE | CFS_READ);
			if (fd_w < 0) {
				printf("failed to open %s\n", FILENAME);
				return 0;
			}
			r_w = cfs_write(fd_w, system_update, (sizeof(system_update) / sizeof(system_update[0])));
			if(r_w != (sizeof(system_update) / sizeof(system_update[0]))) {
				printf("failed to write %d bytes to %s\n", (int)sizeof(system_update), FILENAME);
				cfs_close(fd_w);
				return 0;
			}
			cfs_close(fd_w);
			printf("Successfully wrote data to \"%s\" wrote %d bytes\n", FILENAME, r_w);
        }
        if(data == &button0_sensor) {
        	leds_toggle(LEDS_USER1);
        	uint8_t cfs_system_update[UPDATE_SIZE];
			int i = 0;
			int fd_r = 0; int r_r = 0;
			int elf = 0;
			fd_r = cfs_open(FILENAME, CFS_READ | CFS_WRITE);
			if (fd_r < 0) {
				printf("failed to open %s\n", FILENAME);
				return 0;
			}
			r_r = cfs_read(fd_r, cfs_system_update, (UPDATE_SIZE - 16));

			int j = 1;
			for (i = 0; i < (UPDATE_SIZE - 20); i++) {
				printf("0x%02X,", cfs_system_update[i]);
				if(j % 20 == 0 && j != 0) {
					printf("\n");
				}
				j++;
			}

			printf("\nREAD %d bytes, counter j: %d, array length: %d \n", r_r, j, sizeof(cfs_system_update));

			printf("\n\n");

			elf = elfloader_load(fd_r);
			printf("Elf loader returned: %d \n", elf);

			if(elf == 0) {
				// relocations succeeded
				print_processes(elfloader_autostart_processes);
				autostart_start(elfloader_autostart_processes);
			}

			cfs_close(fd_r);
        }
    }

    PROCESS_END();
}

PROCESS_THREAD(led_test_process, ev, data) {
    PROCESS_BEGIN();

    while (1) {
        etimer_set(&et_led, 0.2*CLOCK_SECOND);

        PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&et_led));
        // the same as
        // PROCESS_WAIT_EVENT_UNTIL(ev == PROCESS_EVENT_TIMER);

    	leds_toggle(LEDS_USER2);
    }

    PROCESS_END();
}
